{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}

{% include "navbar-simple.html" %}
{% include "sidebar.html" %}

<div id="layoutSidenav_content">
<main>

    <div class="card mb-4">
        <div class="card-header"><i class="fas fa-table mr-1"></i> <b>Current Position: Analyzing Cell Communications in Single Dataset </b> </div>
    </div>

    <!-- form. -->
    <div class="card mb-4">
        <div class="card-header"><i class="fas fa-chart-area mr-1"></i> Filters </div>
        <div class="card-body">
             <form method="POST">
                <input type="radio" name="option" value="option1" id="option1" onclick="toggleForm(this)">
                <label for="option1"> Ligand–receptor (LR) network </label>

                <input type="radio" name="option" value="option2" id="option2" onclick="toggleForm(this)">
                <label for="option2"> Signaling pathway </label>
                 (Required; Choices are mutually exclusive.)
             </form>

            <div id="form-group1" style="display: none;">
                <form method="POST"  action="{% url 'analyze-cell-commu-single' %}"> <!-- 这里需要定义 form id -->
                  {% csrf_token %}

                  <label for="f_dataset">Dataset</label>  <!-- 需要定义 关键变量标签 for -->
                  <input type="checkbox" id="f_dataset" name="f_dataset_checkbox" checked> <!-- 需要定义 id和name，id同上一行for -->
                  <select name="f_dataset_condition"> <!-- 需要定义 name -->
                        
                        <option value="contains" selected> Contains </option>
                  </select>
                  <input type="text" name="f_dataset_value"> (Required)
                  <br>

                  <label for="f_pathway">Signal Pathway</label>
                  <input type="checkbox" id="f_pathway" name="f_pathway_checkbox">
                  <select name="f_pathway_condition">
                        
                        <option value="contains" selected> Contains </option>
                  </select>
                  <input type="text" name="f_pathway_value"> (Optional)
                  <br>

                  <label for="f_source">Source Cells</label>
                  <input type="checkbox" id="f_source" name="f_source_checkbox">
                  <select name="f_source_condition">
                        <option value="contains" selected> Contains </option>
                        
                  </select>
                  <input type="text" name="f_source_value"> (Optional)
                  <br>

                  <label for="f_target">Target Cells</label>
                  <input type="checkbox" id="f_target" name="f_target_checkbox">
                  <select name="f_target_condition">
                        <option value="contains" selected> Contains </option>
                        
                  </select>
                  <input type="text" name="f_target_value"> (Optional)
                  <br>

                  <label for="f_ligand">Ligand </label>
                  <input type="checkbox" id="f_ligand" name="f_ligand_checkbox" checked>
                  <select name="f_ligand_condition">
                        <option value="contains" selected> Contains </option>
                        
                  </select>
                  <input type="text" name="f_ligand_value"> (Required)
                  <br>

                  <label for="f_receptor">Receptor </label>
                  <input type="checkbox" id="f_receptor" name="f_receptor_checkbox" checked>
                  <select name="f_receptor_condition">
                        <option value="contains" selected> Contains </option>
                       
                  </select>
                  <input type="text" name="f_receptor_value"> (Required)
                  <br>

                  <label for="f_pval">Permutation Pe-value </label>
                  <input type="checkbox" id="f_pval" name="f_pval_checkbox" >
                  <select name="f_pval_condition">
                        
                        <option value="lt" selected>Less than</option>
                        
                  </select>
                  <input type="text" name="f_pval_value"> (Optional)
                  <br>

                  <input type="submit" value="Submit">
             </form>
            </div>

            <div id="form-group2" style="display: none;">
                <form method="POST" action="{% url 'analyze-cell-commu-single' %}">
                    {% csrf_token %}

                    <label for="f_dataset">Dataset</label>  <!-- 需要定义 关键变量标签 for -->
                    <input type="checkbox" id="f_dataset" name="f_dataset_checkbox" checked> <!-- 需要定义 id和name，id同上一行for -->
                    <select name="f_dataset_condition"> <!-- 需要定义 name -->
                        <option value="eq"> Equal to </option>
                        <option value="contains" selected> Contains </option>
                    </select>
                    <input type="text" name="f_dataset_value"> (Required)
                    <br>

                    <label for="f_pathway">Signal Pathway</label>
                    <input type="checkbox" id="f_pathway" name="f_pathway_checkbox">
                    <select name="f_pathway_condition">
                        <option value="eq">Equal to</option>
                        <option value="contains" selected> Contains </option>
                    </select>
                    <input type="text" name="f_pathway_value"> (Optional)
                    <br>

                    <label for="f_source">Source Cells</label>
                    <input type="checkbox" id="f_source" name="f_source_checkbox">
                    <select name="f_source_condition">
                        <option value="contains" selected> Contains </option>
                        <option value="eq">Equal to</option>
                    </select>
                    <input type="text" name="f_source_value"> (Optional)
                    <br>

                    <label for="f_target">Target Cells</label>
                    <input type="checkbox" id="f_target" name="f_target_checkbox">
                    <select name="f_target_condition">
                        <option value="contains" selected> Contains </option>
                        <option value="eq">Equal to</option>
                    </select>
                    <input type="text" name="f_target_value"> (Optional)
                    <br>

                    <label for="f_pval">Permutation Pe-value </label>
                    <input type="checkbox" id="f_pval" name="f_pval_checkbox" >
                    <select name="f_pval_condition">
                        <option value="gt">Greater than</option>
                        <option value="lt" selected>Less than</option>
                        <option value="eq">Equal to</option>
                    </select>
                    <input type="text" name="f_pval_value"> (Optional)
                    <br>

                  <!-- 其他字段的复选框和查询条件 -->
                    <input type="submit" value="Submit">
                </form>
            </div>
        </div>

        <script>
            function toggleForm(radio) {
              var formGroup1 = document.getElementById('form-group1');
              var formGroup2 = document.getElementById('form-group2');

              if (radio.value === 'option1') {
                formGroup1.style.display = 'block';
                formGroup2.style.display = 'none';
              } else if (radio.value === 'option2') {
                formGroup1.style.display = 'none';
                formGroup2.style.display = 'block';
              }
            }
            </script>

    </div>

    <!-- 显示user提交的form查询条件 -->
    <div class="card mb-4" id="result-form-input">
        <div class="card-header"><i class="fas fa-chart-area mr-1"></i> Current inputs </div>
        <div class="card-body">
            {% if error_message %}
                <p style="color: red;"> Error Occured !!! </p>
<!--                <p style="color: red;"> One or more required fields are missing.</p>-->
                <p style="color: red;">{{ error_message }}</p>
            {% endif %}

            {% if filters %}
              <ul>
                {% for key, value in filters.items %}
                  <li>{{ key }}: {{ value }}</li>
                {% endfor %}
              </ul>
            {% endif %}
        </div>
    </div>

    <!-- summary of data subset according to the form -->
    <div class="card mb-4" id="result-dataTable-summary">
        <div class="card-header"><i class="fas fa-chart-area mr-1"></i> Summary of Data Subset </div>
        <div class="card-body">
            <p> Number of total records: {{ total_records }} </p>
            <p> num_distinct_values_of_dataset: {{ num_distinct_values_of_dataset }} </p>
            <p> dataset_distinct_values: {{ dataset_distinct_values }} </p>
            <p> {{ num_distinct_values_of_gene }} gene markers of {{ num_distinct_values_of_cluster }} cell clusters (major cell type or cell subtypes) </p>
            <p> {{ pct1_summary_stats }}</p>
            <p> {{ pct2_summary_stats }}</p>
        </div>
    </div>

    <!-- dataTable of data subset -->
    <div class="card mb-4" id="result-dataTable">
        <div class="card-header"><i class="fas fa-chart-area mr-1"></i> Filter Results </div>
        <div class="card-body" id="filter-tab1-results-container">
             <div class="table-responsive">
                <table class="table table-bordered" id="dataTable-filter" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Dataset</th>
                            <th>Cell Type</th>
                            <th>Gene</th>
                            <th>Avg_log2FC</th>
                            <th>Pct1</th>
                            <th>Pct2</th>
                            <th>P-value</th>
                            <th>Adjusted P</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th>Dataset</th>
                            <th>Cell Type</th>
                            <th>Gene</th>
                            <th>Avg_log2FC</th>
                            <th>Pct1</th>
                            <th>Pct2</th>
                            <th>P-value</th>
                            <th>Adjusted P</th>
                        </tr>
                    </tfoot>
                    <tbody>
                       {% for row in filter_results %}
                        <tr>
                            <td>{{ row.dataset }}</td>
                            <td>{{ row.cluster }}</td>
                            <td>{{ row.gene }}</td>
                            <td>{{ row.avg_log2FC }}</td>
                            <td>{{ row.pct1 }}</td>
                            <td>{{ row.pct2 }}</td>
                            <td>{{ row.pval }}</td>
                            <td>{{ row.padj }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
             </div>
        </div>
    </div>

    <!-- plt with data subset -->
    <div class="card mb-4" id="result-plots">
    <div class="card-header"><i class="fas fa-chart-area mr-1"></i> Plots </div>
    <div class="card-body">
        {{ plot_url | safe }}
    </div>
</div>

</main>

{% include "footer.html" %}
</div>
</div>

<!-- Javascript code. -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<!--<script src="../static/js/scripts.js"></script>-->
<script src="{% static 'js/scripts.js' %}"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js" crossorigin="anonymous"></script>


<!-- for #dataTable functions-->
<script type="text/javascript">
    // 用来优化网页表格的显示
   $(document).ready(function() {
      $('#dataTable-filter').dataTable();
    });
</script>

{% endblock %}
